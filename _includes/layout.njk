<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title or "Ergophobia" }}</title>
    <!-- Basic meta -->
    <meta
    name="description" content="{{ description or (content | excerpt) }}"> <!-- Open Graph for nice link previews when shared -->
    <meta property="og:title" content="{{ title or 'Ergophobia' }}">
    <meta property="og:description" content="{{ description or (content | excerpt) }}">
    <meta property="og:type" content="article">
    <meta property="og:url" content="{{ page.url | absoluteUrl(site.url) }}">
    <link rel="stylesheet" href="/styles/main.css">
  <script>
    // Theme toggle functionality - runs immediately to set initial theme
    (function() {
      // Get saved theme or default to system preference
      function getInitialTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
          return savedTheme;
        }
        // Check system preference
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      
      // Apply theme (can run before DOM is ready for initial theme)
      function setTheme(theme, updateIcons) {
        const root = document.documentElement;
        if (theme === 'dark') {
          root.classList.add('dark-mode');
          root.classList.remove('light-mode');
          if (updateIcons) {
            const themeToggleSun = document.getElementById('theme-toggle-sun');
            const themeToggleMoon = document.getElementById('theme-toggle-moon');
            if (themeToggleSun) themeToggleSun.style.display = 'block';
            if (themeToggleMoon) themeToggleMoon.style.display = 'none';
          }
        } else {
          root.classList.add('light-mode');
          root.classList.remove('dark-mode');
          if (updateIcons) {
            const themeToggleSun = document.getElementById('theme-toggle-sun');
            const themeToggleMoon = document.getElementById('theme-toggle-moon');
            if (themeToggleSun) themeToggleSun.style.display = 'none';
            if (themeToggleMoon) themeToggleMoon.style.display = 'block';
          }
        }
        localStorage.setItem('theme', theme);
      }
      
      // Initialize theme immediately (before DOM ready for faster rendering)
      const initialTheme = getInitialTheme();
      setTheme(initialTheme, false);
      
      // Wait for DOM to be ready to set up toggle button
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initThemeToggle);
      } else {
        initThemeToggle();
      }
      
      function initThemeToggle() {
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleSun = document.getElementById('theme-toggle-sun');
        const themeToggleMoon = document.getElementById('theme-toggle-moon');
        
        // Update icons for current theme
        const currentTheme = document.documentElement.classList.contains('dark-mode') ? 'dark' : 'light';
        setTheme(currentTheme, true);
        
        // Handle toggle button click
        if (themeToggle) {
          themeToggle.addEventListener('click', function() {
            const currentTheme = document.documentElement.classList.contains('dark-mode') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme, true);
          });
        }
        
        // Listen for system theme changes (optional)
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
          // Only update if user hasn't manually set a preference
          if (!localStorage.getItem('theme')) {
            setTheme(e.matches ? 'dark' : 'light', true);
          }
        });
      }
    })();

    // Share button functionality - runs on page load
    (function() {
      function attachShareListeners() {
        document.querySelectorAll('.share-btn').forEach(btn => {
          // Skip if already has listener
          if (btn.dataset.shareListenerAttached) return;
          btn.dataset.shareListenerAttached = 'true';
          
          btn.addEventListener('click', async function() {
            const url = this.getAttribute('data-url');
            const shareIcon = this.querySelector('.share-icon');
            const checkmarkIcon = this.querySelector('.checkmark-icon');
            const tooltip = this.querySelector('.copy-tooltip');
            
            try {
              await navigator.clipboard.writeText(url);

              // Switch to checkmark icon
              if (shareIcon) shareIcon.style.display = 'none';
              if (checkmarkIcon) checkmarkIcon.style.display = 'block';
              
              // Show tooltip
              if (tooltip) {
                tooltip.style.opacity = '1';
                tooltip.style.visibility = 'visible';
              }

              // Reset after 2 seconds
              setTimeout(() => {
                if (shareIcon) shareIcon.style.display = 'block';
                if (checkmarkIcon) checkmarkIcon.style.display = 'none';
                if (tooltip) {
                  tooltip.style.opacity = '0';
                  tooltip.style.visibility = 'hidden';
                }
              }, 2000);

            } catch (err) {
              console.error('Copy failed', err);
              prompt('Copy failed — copy manually:', url);
            }
          });
        });
      }

      // Initialize share listeners on page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachShareListeners);
      } else {
        attachShareListeners();
      }
    })();
  </script>
</head>
<body>
  <header class="site-header">
    <h1 class="site-title">
      <a href="/">Ergophobia</a>
    </h1>
    <button id="theme-toggle" 
            aria-label="Toggle dark mode"
            title="Toggle dark/light mode"
            class="theme-toggle-btn">
      <svg id="theme-toggle-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
      <svg id="theme-toggle-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>
  </header>
  <main>
    {% block content %}
      {{ content | safe }}
    {% endblock %}
  </main>
  <footer class="site-footer">
    <p>
      © {{ "now" | formatDate('yyyy') }} Ergophobia
    </p>
    {% if page.url != '/' %}
      <p class="back-link">
        <a href="/">← Back to feed</a>
      </p>
    {% endif %}
  </footer>
</body></html>
